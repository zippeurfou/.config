#!/usr/bin/env bash
alias ls='eza -ahlF --color=always --icons=always --git --total-size --no-user --no-time --no-permissions '
alias ll='ls -lahF'
alias la='ls -alh'
alias dif="git diff --no-index"                                                                   # Diff two files even if not in git repo! Can add -w (don't diff whitespaces)
alias tmuxk='tmux kill-session -t'
alias tmuxa='tmux attach -t'
alias tmuxl='tmux list-sessions'
function nvim_env() {
 # If I have VIRTUAL_ENV and a local pyenv (to avoid creating pyrightconfig.json everywhere) but not the pyrightconfig.json create it
  if test -e "$VIRTUAL_ENV" && test -f .python-version && test ! -f pyrightconfig.json; then
    echo "VIRTUAL_ENV detected adding pyrightconfig.json"
    sleep 2
    pyenv pyright
  fi
  if [[ -e "$VIRTUAL_ENV" && -f "$VIRTUAL_ENV/bin/activate" ]]; then
    source "$VIRTUAL_ENV/bin/activate"
    command nvim "$@"
    deactivate
  else
    command nvim "$@"
  fi
}
# nvim aliases
alias vim="nvim_env"
alias nvim="nvim_env"
alias v="nvim_env"
# custom alias to create project
alias create_project='create_project_function'

create_project_function() {
    if [ $# -ne 2 ]; then
        echo "Usage: create_project {folder_name} {virtualenv_version}"
        return 1
    fi

    folder_name="$1"
    virtualenv_version="$2"

    cd ~/Projects || return
    gh repo create "$folder_name" --private --license mit --gitignore=Python
    gh repo clone "$folder_name"
    cd ~/Projects/"$folder_name" || return
    local readme_content="# $folder_name\n\n## Description\n\nAdd project description here.\n\n## Getting Started\n\nAdd instructions on how to get started with the project.\n"
    echo "$readme_content" > README.md
    uv init --python "$virtualenv_version" --name "$folder_name"
    git add README.md
    git commit -m "Initial commit with README"
    git push


}


# Function to export a keyring variable
keyring_export() {
  local var="$1"
  local service="${2:-system}"

  local value
  value=$(security find-generic-password -s "$service" -a "$var" -g 2>&1 | awk -F\" '/password:/ {print $2}')

  if [[ -z "$value" ]]; then
    echo "‚ö†Ô∏è Failed to load password for $var (service: $service)" >&2
    return 1
  fi

  export "$var=$value"
}

# opencode setup automation
opencode_setup() {
    local upgrade_marker="/tmp/.opencode_brew_upgrade_$(date +%Y%m%d)"
    
    # Only upgrade once per day
    if [[ ! -f "$upgrade_marker" ]]; then
        echo "üîÑ Upgrading opencode..."
        if brew upgrade sst/tap/opencode; then
            echo "‚úÖ opencode upgraded successfully"
            touch "$upgrade_marker"
        else
            echo "‚ö†Ô∏è opencode upgrade failed or already up to date"
            touch "$upgrade_marker"  # Still mark as done to avoid repeated attempts
        fi
    else
        echo "‚è≠Ô∏è Skipping brew upgrade (already done today)"
    fi
    
    # Try to export credentials first
    echo "üìã Attempting to export AWS credentials..."
    local cred_output
    cred_output=$(aws configure export-credentials --profile data --format env 2>&1)
    
    if echo "$cred_output" | grep -q "Token has expired\|expired and refresh failed\|Unable to load SSO Token"; then
        echo "üîê AWS tokens expired, logging into AWS SSO..."
        if aws sso login --profile data; then
            echo "‚úÖ AWS SSO login successful"
            echo "üìã Exporting AWS credentials..."
            if eval "$(aws configure export-credentials --profile data --format env)"; then
                echo "‚úÖ AWS credentials exported successfully"
                echo "‚è∞ Credentials expire at: $AWS_CREDENTIAL_EXPIRATION"
            else
                echo "‚ùå Failed to export AWS credentials after login"
                return 1
            fi
        else
            echo "‚ùå AWS SSO login failed"
            return 1
        fi
    elif echo "$cred_output" | grep -q "export AWS_ACCESS_KEY_ID"; then
        eval "$cred_output"
        echo "‚úÖ AWS credentials exported successfully"
        echo "‚è∞ Credentials expire at: $AWS_CREDENTIAL_EXPIRATION"
    else
        echo "‚ùå Failed to export AWS credentials: $cred_output"
        return 1
    fi
    
    echo "üöÄ Starting opencode..."
    opencode
}

# Alias for convenience
alias oc='opencode_setup'

# this allow me to do d and a number to access them
alias d='dirs -v'
for index ({1..9}) alias "$index"="cd +${index}"; unset index
